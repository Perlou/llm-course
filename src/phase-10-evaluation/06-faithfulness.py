"""
å¿ å®åº¦è¯„ä¼°
==========

å­¦ä¹ ç›®æ ‡ï¼š
    1. ç†è§£å¿ å®åº¦è¯„ä¼°çš„é‡è¦æ€§
    2. å®ç°åŸºäº NLI çš„å¿ å®åº¦æ£€æµ‹
    3. è¯†åˆ«å’Œå‡å°‘ LLM å¹»è§‰

æ ¸å¿ƒæ¦‚å¿µï¼š
    - Faithfulnessï¼šå›ç­”æ˜¯å¦å¿ å®äºä¸Šä¸‹æ–‡
    - Hallucinationï¼šæ¨¡å‹ç”Ÿæˆè™šå‡ä¿¡æ¯
    - NLIï¼šè‡ªç„¶è¯­è¨€æ¨ç†

ç¯å¢ƒè¦æ±‚ï¼š
    - pip install transformers openai
"""

import os
from typing import List
from dotenv import load_dotenv

load_dotenv()


# ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šå¿ å®åº¦æ¦‚å¿µ ====================


def introduction():
    """å¿ å®åº¦æ¦‚å¿µ"""
    print("=" * 60)
    print("ç¬¬ä¸€éƒ¨åˆ†ï¼šå¿ å®åº¦æ¦‚å¿µ")
    print("=" * 60)

    print("""
    ğŸ“Œ ä»€ä¹ˆæ˜¯å¿ å®åº¦ (Faithfulness)ï¼Ÿ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å›ç­”ä¸­çš„æ¯ä¸ªå£°æ˜æ˜¯å¦éƒ½èƒ½ä»ç»™å®šçš„ä¸Šä¸‹æ–‡ä¸­æ¨æ–­å‡ºæ¥       â”‚
    â”‚                                                         â”‚
    â”‚  å¿ å®åº¦ = (å¯ä»ä¸Šä¸‹æ–‡æ¨æ–­çš„å£°æ˜æ•°) / (æ€»å£°æ˜æ•°)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“Œ ä¸ºä»€ä¹ˆå…³æ³¨å¿ å®åº¦ï¼Ÿ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â€¢ æ£€æµ‹å¹»è§‰ (Hallucination)                            â”‚
    â”‚  â€¢ ç¡®ä¿å›ç­”åŸºäºäº‹å®                                    â”‚
    â”‚  â€¢ æé«˜ RAG ç³»ç»Ÿå¯ä¿¡åº¦                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“Œ å¹»è§‰ç±»å‹ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ äº‹å®æ€§å¹»è§‰   â”‚ ç”Ÿæˆä¸äº‹å®ä¸ç¬¦çš„å†…å®¹                   â”‚
    â”‚ ç¼–é€ å¹»è§‰     â”‚ å‡­ç©ºåˆ›é€ ä¸å­˜åœ¨çš„ä¿¡æ¯                   â”‚
    â”‚ æ¨ç†å¹»è§‰     â”‚ ä»æ­£ç¡®å‰æå¾—å‡ºé”™è¯¯ç»“è®º                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)


# ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºäº LLM çš„å¿ å®åº¦è¯„ä¼° ====================


def llm_based_evaluation():
    """åŸºäº LLM çš„å¿ å®åº¦è¯„ä¼°"""
    print("\n" + "=" * 60)
    print("ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºäº LLM çš„å¿ å®åº¦è¯„ä¼°")
    print("=" * 60)

    code = '''
from openai import OpenAI

client = OpenAI()

FAITHFULNESS_PROMPT = """
è¯·åˆ†æä»¥ä¸‹å›ç­”æ˜¯å¦å¿ å®äºç»™å®šçš„ä¸Šä¸‹æ–‡ã€‚

ä¸Šä¸‹æ–‡ï¼š
{context}

å›ç­”ï¼š
{answer}

è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. å°†å›ç­”åˆ†è§£ä¸ºç‹¬ç«‹çš„å£°æ˜/é™ˆè¿°
2. å¯¹æ¯ä¸ªå£°æ˜ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½ä»ä¸Šä¸‹æ–‡ä¸­æ¨æ–­å‡ºæ¥
3. è®¡ç®—å¿ å®åº¦åˆ†æ•°

è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š
{{
    "claims": [
        {{"claim": "å£°æ˜1", "supported": true/false, "reason": "åŸå› "}},
        ...
    ],
    "faithfulness_score": 0.0-1.0,
    "unsupported_claims": ["ä¸æ”¯æŒçš„å£°æ˜åˆ—è¡¨"]
}}
"""

def evaluate_faithfulness(context: str, answer: str) -> dict:
    """ä½¿ç”¨ LLM è¯„ä¼°å¿ å®åº¦"""
    prompt = FAITHFULNESS_PROMPT.format(context=context, answer=answer)

    response = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0
    )

    import json
    return json.loads(response.choices[0].message.content)

# ä½¿ç”¨ç¤ºä¾‹
context = "åŒ—äº¬æ˜¯ä¸­å›½çš„é¦–éƒ½ï¼Œäººå£çº¦2100ä¸‡ã€‚ä¸Šæµ·æ˜¯ä¸­å›½æœ€å¤§çš„åŸå¸‚ã€‚"
answer = "åŒ—äº¬æ˜¯ä¸­å›½çš„é¦–éƒ½ï¼Œäººå£çº¦3000ä¸‡ï¼Œæ˜¯ä¸–ç•Œä¸Šæœ€å¤§çš„åŸå¸‚ã€‚"

result = evaluate_faithfulness(context, answer)
# é¢„æœŸ: ç¬¬ä¸€ä¸ªå£°æ˜æ­£ç¡®ï¼Œåä¸¤ä¸ªå£°æ˜ä¸æ”¯æŒï¼Œfaithfulness_score çº¦ 0.33
'''
    print(code)


# ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šåŸºäº NLI çš„å¿ å®åº¦è¯„ä¼° ====================


def nli_based_evaluation():
    """åŸºäº NLI çš„å¿ å®åº¦è¯„ä¼°"""
    print("\n" + "=" * 60)
    print("ç¬¬ä¸‰éƒ¨åˆ†ï¼šåŸºäº NLI çš„å¿ å®åº¦è¯„ä¼°")
    print("=" * 60)

    code = '''
from transformers import pipeline

# åŠ è½½ NLI æ¨¡å‹
nli_model = pipeline(
    "text-classification",
    model="facebook/bart-large-mnli"
)

def check_entailment(premise: str, hypothesis: str) -> dict:
    """æ£€æŸ¥å‰ææ˜¯å¦è•´å«å‡è®¾"""
    result = nli_model(
        f"{premise} [SEP] {hypothesis}",
        return_all_scores=True
    )
    return result

def evaluate_faithfulness_nli(context: str, claims: list) -> dict:
    """ä½¿ç”¨ NLI è¯„ä¼°å¿ å®åº¦"""
    results = []
    supported_count = 0

    for claim in claims:
        # æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦è•´å«è¯¥å£°æ˜
        nli_result = check_entailment(context, claim)

        # è§£æç»“æœ
        entailment_score = 0
        for item in nli_result[0]:
            if item['label'] == 'entailment':
                entailment_score = item['score']
                break

        is_supported = entailment_score > 0.5
        if is_supported:
            supported_count += 1

        results.append({
            "claim": claim,
            "supported": is_supported,
            "entailment_score": entailment_score
        })

    faithfulness = supported_count / len(claims) if claims else 0

    return {
        "claim_results": results,
        "faithfulness_score": faithfulness
    }
'''
    print(code)


# ==================== ç¬¬å››éƒ¨åˆ†ï¼šå‡å°‘å¹»è§‰çš„ç­–ç•¥ ====================


def reduce_hallucination():
    """å‡å°‘å¹»è§‰çš„ç­–ç•¥"""
    print("\n" + "=" * 60)
    print("ç¬¬å››éƒ¨åˆ†ï¼šå‡å°‘å¹»è§‰çš„ç­–ç•¥")
    print("=" * 60)

    print("""
    ğŸ“Œ æç¤ºè¯å±‚é¢ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. æ˜ç¡®è¦æ±‚"ä»…åŸºäºæä¾›çš„ä¸Šä¸‹æ–‡å›ç­”"                    â”‚
    â”‚ 2. æ·»åŠ "å¦‚æœä¿¡æ¯ä¸è¶³ï¼Œè¯·è¯´æ˜"                          â”‚
    â”‚ 3. ä½¿ç”¨å¼•ç”¨æ ¼å¼ï¼Œæ ‡æ³¨ä¿¡æ¯æ¥æº                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“Œ ç³»ç»Ÿå±‚é¢ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. æé«˜æ£€ç´¢è´¨é‡ï¼Œç¡®ä¿ä¸Šä¸‹æ–‡å……è¶³                         â”‚
    â”‚ 2. æ·»åŠ åå¤„ç†ï¼ŒéªŒè¯å…³é”®å£°æ˜                            â”‚
    â”‚ 3. å¤šæ¬¡ç”Ÿæˆå–å…±è¯†                                      â”‚
    â”‚ 4. ä½¿ç”¨ RAG èåˆå¤šä¸ªæ¥æº                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“Œ ç¤ºä¾‹ Promptï¼š
    ```
    è¯·ä»…åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ã€‚
    å¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰è¶³å¤Ÿä¿¡æ¯ï¼Œè¯·æ˜ç¡®è¯´æ˜"æ ¹æ®æä¾›çš„ä¿¡æ¯æ— æ³•ç¡®å®š"ã€‚
    åœ¨å›ç­”ä¸­å¼•ç”¨ç›¸å…³çš„ä¸Šä¸‹æ–‡å†…å®¹ã€‚

    ä¸Šä¸‹æ–‡ï¼š{context}
    é—®é¢˜ï¼š{question}
    ```
    """)


# ==================== ç¬¬äº”éƒ¨åˆ†ï¼šç»ƒä¹  ====================


def exercises():
    """ç»ƒä¹ """
    print("\n" + "=" * 60)
    print("ç»ƒä¹ ä¸æ€è€ƒ")
    print("=" * 60)

    print("""
    ç»ƒä¹  1ï¼šå®ç°åŸºäº LLM çš„å¿ å®åº¦è¯„ä¼°å‡½æ•°
    ç»ƒä¹  2ï¼šè®¾è®¡å‡å°‘å¹»è§‰çš„ prompt å¹¶æµ‹è¯•æ•ˆæœ

    æ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆå®Œå…¨æ¶ˆé™¤å¹»è§‰å¾ˆå›°éš¾ï¼Ÿ
    ç­”æ¡ˆï¼š1. LLM æ˜¯æ¦‚ç‡æ¨¡å‹ï¼Œæ— æ³•ä¿è¯å®Œå…¨å‡†ç¡®
          2. è®­ç»ƒæ•°æ®å¯èƒ½åŒ…å«é”™è¯¯ä¿¡æ¯
          3. æ¨¡å‹å€¾å‘äºç”Ÿæˆæµç•…è€Œéå‡†ç¡®çš„å†…å®¹
    """)


def main():
    introduction()
    llm_based_evaluation()
    nli_based_evaluation()
    reduce_hallucination()
    exercises()
    print("\nè¯¾ç¨‹å®Œæˆï¼ä¸‹ä¸€æ­¥ï¼š07-prompt-optimization.py")


if __name__ == "__main__":
    main()
