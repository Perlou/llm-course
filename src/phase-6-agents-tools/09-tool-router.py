"""
å·¥å…·è·¯ç”±
=======

å­¦ä¹ ç›®æ ‡ï¼š
    1. ç†è§£å·¥å…·è·¯ç”±çš„æ¦‚å¿µ
    2. å®ç°æ™ºèƒ½å·¥å…·é€‰æ‹©
    3. æ„å»ºå·¥å…·è·¯ç”±å™¨

æ ¸å¿ƒæ¦‚å¿µï¼š
    - å·¥å…·è·¯ç”±ï¼šæ ¹æ®ä»»åŠ¡é€‰æ‹©åˆé€‚çš„å·¥å…·
    - è·¯ç”±ç­–ç•¥ï¼šåŸºäºè§„åˆ™ã€è¯­ä¹‰ç›¸ä¼¼åº¦ã€LLM
    - å¤šå·¥å…·åä½œ

å‰ç½®çŸ¥è¯†ï¼š
    - 04-06 å·¥å…·ç›¸å…³è¯¾ç¨‹

ç¯å¢ƒè¦æ±‚ï¼š
    - pip install openai python-dotenv
"""

import os
from typing import Dict, List, Callable
from dotenv import load_dotenv

load_dotenv()


# ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šå·¥å…·è·¯ç”±æ¦‚å¿µ ====================


def routing_concept():
    """å·¥å…·è·¯ç”±æ¦‚å¿µ"""
    print("=" * 60)
    print("ç¬¬ä¸€éƒ¨åˆ†ï¼šå·¥å…·è·¯ç”±æ¦‚å¿µ")
    print("=" * 60)

    print("""
    ä»€ä¹ˆæ˜¯å·¥å…·è·¯ç”±ï¼Ÿ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    å½“æœ‰å¤šä¸ªå·¥å…·æ—¶ï¼Œå¦‚ä½•é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·ï¼Ÿ
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              å·¥å…·è·¯ç”±å™¨                       â”‚
    â”‚                                             â”‚
    â”‚  ç”¨æˆ·è¯·æ±‚ â”€â”€â†’ [Router] â”€â”€â†’ é€‰æ‹©å·¥å…·          â”‚
    â”‚                  â”‚                          â”‚
    â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
    â”‚       â–¼         â–¼         â–¼                â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚   â”‚æœç´¢  â”‚ â”‚è®¡ç®—  â”‚ â”‚å¤©æ°”  â”‚ ...           â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜              â”‚
    â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    è·¯ç”±ç­–ç•¥ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€
    1. åŸºäºè§„åˆ™ï¼šå…³é”®è¯åŒ¹é…
    2. è¯­ä¹‰ç›¸ä¼¼åº¦ï¼šå·¥å…·æè¿°ä¸è¯·æ±‚çš„ç›¸ä¼¼åº¦
    3. LLM å†³ç­–ï¼šè®©å¤§æ¨¡å‹é€‰æ‹©
    """)


# ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šè§„åˆ™è·¯ç”± ====================


def rule_based_router():
    """è§„åˆ™è·¯ç”±"""
    print("\n" + "=" * 60)
    print("ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºäºè§„åˆ™çš„è·¯ç”±")
    print("=" * 60)

    class RuleBasedRouter:
        """åŸºäºè§„åˆ™çš„å·¥å…·è·¯ç”±å™¨"""

        def __init__(self):
            self.tools = {}
            self.rules = {}

        def register(self, name: str, func: Callable, keywords: List[str]):
            """æ³¨å†Œå·¥å…·å’Œè§„åˆ™"""
            self.tools[name] = func
            self.rules[name] = keywords

        def route(self, query: str) -> str:
            """è·¯ç”±åˆ°åˆé€‚çš„å·¥å…·"""
            query_lower = query.lower()

            scores = {}
            for name, keywords in self.rules.items():
                score = sum(1 for kw in keywords if kw in query_lower)
                scores[name] = score

            if max(scores.values()) == 0:
                return None

            return max(scores, key=scores.get)

        def execute(self, query: str) -> str:
            """è·¯ç”±å¹¶æ‰§è¡Œ"""
            tool_name = self.route(query)
            if tool_name:
                return f"[{tool_name}] {self.tools[tool_name](query)}"
            return "æœªæ‰¾åˆ°åˆé€‚çš„å·¥å…·"

    router = RuleBasedRouter()

    # æ³¨å†Œå·¥å…·
    router.register(
        "calculator",
        lambda q: "è®¡ç®—ç»“æœ: 42",
        ["è®¡ç®—", "åŠ ", "å‡", "ä¹˜", "é™¤", "+", "-"],
    )
    router.register("weather", lambda q: "æ™´ï¼Œ25Â°C", ["å¤©æ°”", "æ¸©åº¦", "ä¸‹é›¨"])
    router.register("search", lambda q: "æœç´¢ç»“æœ...", ["æœç´¢", "æŸ¥è¯¢", "æ‰¾", "ä»€ä¹ˆæ˜¯"])

    print("ğŸ“Œ è§„åˆ™è·¯ç”±æµ‹è¯•ï¼š")
    tests = ["è®¡ç®— 100 + 200", "åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·", "æœç´¢ Python æ•™ç¨‹"]
    for q in tests:
        result = router.execute(q)
        print(f"  '{q}' â†’ {result}")


# ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯­ä¹‰è·¯ç”± ====================


def semantic_router():
    """è¯­ä¹‰è·¯ç”±"""
    print("\n" + "=" * 60)
    print("ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦è·¯ç”±")
    print("=" * 60)

    print("""
    è¯­ä¹‰è·¯ç”±åŸç†
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    1. å°†å·¥å…·æè¿°è½¬æ¢ä¸ºå‘é‡
    2. å°†ç”¨æˆ·è¯·æ±‚è½¬æ¢ä¸ºå‘é‡
    3. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    4. é€‰æ‹©æœ€ç›¸ä¼¼çš„å·¥å…·
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â”‚  è¯·æ±‚å‘é‡ â”€â”€â”€â”€â”                              â”‚
    â”‚              â”œâ”€â”€â†’ ç›¸ä¼¼åº¦è®¡ç®— â”€â”€â†’ é€‰æ‹©å·¥å…·   â”‚
    â”‚  å·¥å…·å‘é‡ â”€â”€â”€â”€â”˜                              â”‚
    â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)

    # ç®€åŒ–å®ç°ï¼ˆå®é™…åº”ç”¨ä½¿ç”¨ Embeddingï¼‰
    class SemanticRouter:
        """è¯­ä¹‰è·¯ç”±å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰"""

        def __init__(self):
            self.tools = {}

        def register(self, name: str, description: str, func: Callable):
            self.tools[name] = {
                "description": description,
                "function": func,
                "keywords": set(description.lower().split()),
            }

        def similarity(self, query: str, tool_name: str) -> float:
            """è®¡ç®—ç®€åŒ–çš„ç›¸ä¼¼åº¦"""
            query_words = set(query.lower().split())
            tool_words = self.tools[tool_name]["keywords"]
            intersection = query_words & tool_words
            union = query_words | tool_words
            return len(intersection) / len(union) if union else 0

        def route(self, query: str) -> str:
            scores = {name: self.similarity(query, name) for name in self.tools}
            return max(scores, key=scores.get) if max(scores.values()) > 0 else None

    router = SemanticRouter()
    router.register("weather", "è·å–å¤©æ°”æ¸©åº¦ä¿¡æ¯", lambda: "æ™´")
    router.register("search", "æœç´¢äº’è”ç½‘ä¿¡æ¯", lambda: "ç»“æœ...")

    print("ğŸ“Œ è¯­ä¹‰è·¯ç”±æµ‹è¯•ï¼š")
    print(f"  'å¤©æ°”ä¿¡æ¯' â†’ {router.route('å¤©æ°”ä¿¡æ¯')}")


# ==================== ç¬¬å››éƒ¨åˆ†ï¼šLLM è·¯ç”± ====================


def llm_router():
    """LLM è·¯ç”±"""
    print("\n" + "=" * 60)
    print("ç¬¬å››éƒ¨åˆ†ï¼šLLM è·¯ç”±")
    print("=" * 60)

    code = '''
class LLMRouter:
    """åŸºäº LLM çš„å·¥å…·è·¯ç”±å™¨"""
    
    ROUTER_PROMPT = """
å¯ç”¨å·¥å…·ï¼š
{tool_descriptions}

ç”¨æˆ·è¯·æ±‚ï¼š{query}

è¯·é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·ï¼Œåªè¿”å›å·¥å…·åç§°ã€‚
"""
    
    def __init__(self, client, tools: Dict):
        self.client = client
        self.tools = tools
    
    def route(self, query: str) -> str:
        # æ„å»ºå·¥å…·æè¿°
        descriptions = "\\n".join([
            f"- {name}: {info['description']}"
            for name, info in self.tools.items()
        ])
        
        prompt = self.ROUTER_PROMPT.format(
            tool_descriptions=descriptions,
            query=query
        )
        
        response = self.client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0
        )
        
        return response.choices[0].message.content.strip()
'''

    print("ğŸ“Œ LLM è·¯ç”±å®ç°ï¼š")
    print(code)

    print("""
    LLM è·¯ç”±ä¼˜åŠ¿ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ… ç†è§£è¯­ä¹‰ï¼Œä¸ä¾èµ–å…³é”®è¯
    âœ… å¤„ç†å¤æ‚æ­§ä¹‰è¯·æ±‚
    âœ… å¯ä»¥è§£é‡Šé€‰æ‹©ç†ç”±
    
    åŠ£åŠ¿ï¼š
    âŒ éœ€è¦é¢å¤– API è°ƒç”¨
    âŒ å¢åŠ å»¶è¿Ÿå’Œæˆæœ¬
    """)


# ==================== ç¬¬äº”éƒ¨åˆ†ï¼šå¤šå·¥å…·åä½œ ====================


def multi_tool_routing():
    """å¤šå·¥å…·åä½œ"""
    print("\n" + "=" * 60)
    print("ç¬¬äº”éƒ¨åˆ†ï¼šå¤šå·¥å…·åä½œ")
    print("=" * 60)

    print("""
    å¤šå·¥å…·åä½œåœºæ™¯
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    è¯·æ±‚ï¼š"è®¡ç®—åŒ—äº¬å’Œä¸Šæµ·çš„æ¸©åº¦å·®"
    
    éœ€è¦ï¼š
    1. è°ƒç”¨å¤©æ°”å·¥å…·è·å–åŒ—äº¬æ¸©åº¦
    2. è°ƒç”¨å¤©æ°”å·¥å…·è·å–ä¸Šæµ·æ¸©åº¦
    3. è°ƒç”¨è®¡ç®—å·¥å…·è®¡ç®—å·®å€¼
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â”‚  è¯·æ±‚ â”€â”€â†’ [è·¯ç”±å™¨] â”€â”€â†’ å¤šä¸ªå·¥å…·              â”‚
    â”‚               â”‚                             â”‚
    â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
    â”‚       â–¼       â–¼       â–¼                    â”‚
    â”‚   [å¤©æ°”1] [å¤©æ°”2] [è®¡ç®—]                    â”‚
    â”‚       â”‚       â”‚       â”‚                    â”‚
    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
    â”‚               â”‚                             â”‚
    â”‚               â–¼                             â”‚
    â”‚          æ±‡æ€»ç»“æœ                            â”‚
    â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """)


# ==================== ç¬¬å…­éƒ¨åˆ†ï¼šç»ƒä¹  ====================


def exercises():
    """ç»ƒä¹ é¢˜"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ ä¸æ€è€ƒ")
    print("=" * 60)

    print("""
    ç»ƒä¹  1ï¼šå®ç°åŠ æƒè§„åˆ™è·¯ç”±
        ä¸åŒå…³é”®è¯æœ‰ä¸åŒæƒé‡
    
    ç»ƒä¹  2ï¼šå®ç°å›é€€æœºåˆ¶
        é¦–é€‰å·¥å…·å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢å¤‡é€‰å·¥å…·
    
    æ€è€ƒé¢˜ï¼š
        å¦‚ä½•è¯„ä¼°è·¯ç”±å™¨çš„å‡†ç¡®æ€§ï¼Ÿ
        ç­”ï¼šæ„å»ºæµ‹è¯•é›†ï¼Œè®¡ç®—è·¯ç”±å‡†ç¡®ç‡
    """)


def main():
    print("ğŸ”€ å·¥å…·è·¯ç”±")
    print("=" * 60)

    routing_concept()
    rule_based_router()
    semantic_router()
    llm_router()
    multi_tool_routing()
    exercises()

    print("\n" + "=" * 60)
    print("âœ… è¯¾ç¨‹å®Œæˆï¼ä¸‹ä¸€æ­¥ï¼š10-agent-memory.py")
    print("=" * 60)


if __name__ == "__main__":
    main()
