"""
LangChain æ¡†æ¶æ¦‚è¿°
==================

å­¦ä¹ ç›®æ ‡ï¼š
    1. ç†è§£ LangChain æ¡†æ¶çš„å®šä½å’Œæ ¸å¿ƒä»·å€¼
    2. æŒæ¡ LangChain çš„æ•´ä½“æ¶æ„å’Œç»„ä»¶ä½“ç³»
    3. äº†è§£ LangChain ç”Ÿæ€ç³»ç»Ÿ
    4. å®Œæˆç¬¬ä¸€ä¸ª LangChain åº”ç”¨

æ ¸å¿ƒæ¦‚å¿µï¼š
    - LangChainï¼šå¼€å‘ LLM é©±åŠ¨åº”ç”¨çš„å¼€æºæ¡†æ¶
    - å…­å¤§æ ¸å¿ƒç»„ä»¶ï¼šModelsã€Promptsã€Chainsã€Memoryã€Indexesã€Agents
    - LCELï¼šLangChain Expression Languageï¼Œé“¾å¼è¡¨è¾¾è¯­è¨€

å‰ç½®çŸ¥è¯†ï¼š
    - Phase 1-2 çš„ LLM åŸºç¡€å’Œæç¤ºè¯å·¥ç¨‹
    - Python åŸºç¡€

ç¯å¢ƒè¦æ±‚ï¼š
    - pip install langchain langchain-openai python-dotenv
    - é…ç½® OPENAI_API_KEY
"""

import os
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()


# ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šLangChain æ˜¯ä»€ä¹ˆ ====================


def introduction():
    """LangChain æ¡†æ¶ä»‹ç»"""
    print("=" * 60)
    print("ç¬¬ä¸€éƒ¨åˆ†ï¼šLangChain æ˜¯ä»€ä¹ˆ")
    print("=" * 60)

    intro_text = """
    ä»€ä¹ˆæ˜¯ LangChainï¼Ÿ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    LangChain æ˜¯ä¸€ä¸ªç”¨äºå¼€å‘å¤§è¯­è¨€æ¨¡å‹(LLM)é©±åŠ¨åº”ç”¨ç¨‹åºçš„å¼€æºæ¡†æ¶ï¼Œ
    ç”± Harrison Chase äº 2022 å¹´åˆ›å»ºã€‚å®ƒæä¾›äº†ä¸€å¥—å®Œæ•´çš„å·¥å…·å’ŒæŠ½è±¡ï¼Œ
    ä½¿å¾—æ„å»ºå¤æ‚çš„ AI åº”ç”¨å˜å¾—ç®€å•å’Œæ¨¡å—åŒ–ã€‚
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  LangChain è§£å†³çš„é—®é¢˜                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  âŒ åŸå§‹ LLM çš„å±€é™æ€§       â”‚   âœ… LangChain çš„è§£å†³æ–¹æ¡ˆ    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â€¢ æ— æ³•è®¿é—®å®æ—¶æ•°æ®        â”‚   â€¢ é›†æˆå¤–éƒ¨æ•°æ®æºå’Œ API      â”‚
    â”‚  â€¢ æ— è®°å¿†èƒ½åŠ›             â”‚   â€¢ æä¾› Memory ç»„ä»¶          â”‚
    â”‚  â€¢ æ— æ³•æ‰§è¡Œå¤æ‚ä»»åŠ¡        â”‚   â€¢ Chain é“¾å¼è°ƒç”¨            â”‚
    â”‚  â€¢ æ— æ³•ä½¿ç”¨å¤–éƒ¨å·¥å…·        â”‚   â€¢ Agent æ™ºèƒ½ä»£ç†            â”‚
    â”‚  â€¢ ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶          â”‚   â€¢ æ–‡æ¡£åˆ†å‰²ä¸å‘é‡å­˜å‚¨         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    LangChain ç”Ÿæ€ç³»ç»Ÿï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ langchain   â”‚  â”‚ langchain-  â”‚  â”‚ langsmith   â”‚
    â”‚   æ ¸å¿ƒåº“     â”‚  â”‚ community   â”‚  â”‚  è°ƒè¯•è¿½è¸ª    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚langchain-   â”‚  â”‚ ç¬¬ä¸‰æ–¹é›†æˆ   â”‚  â”‚ langgraph   â”‚
    â”‚  core       â”‚  â”‚ (OpenAIç­‰)  â”‚  â”‚ å¤æ‚å·¥ä½œæµ   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    print(intro_text)


# ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¶æ„ ====================


def core_architecture():
    """LangChain æ ¸å¿ƒæ¶æ„"""
    print("\n" + "=" * 60)
    print("ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¶æ„")
    print("=" * 60)

    architecture_text = """
    LangChain æ•´ä½“æ¶æ„ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     åº”ç”¨å±‚ (Application)                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
    â”‚  â”‚èŠå¤©æœºå™¨äººâ”‚ â”‚é—®ç­”ç³»ç»Ÿ  â”‚ â”‚ä»£ç åŠ©æ‰‹  â”‚ â”‚æ•°æ®åˆ†æ  â”‚           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     æ¡†æ¶å±‚ (LangChain)                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚           LCEL (LangChain Expression Language)        â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Models â”‚ â”‚Prompts â”‚ â”‚ Chains â”‚ â”‚ Memory â”‚ â”‚ Agents â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     é›†æˆå±‚ (Integrations)                    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
    â”‚  â”‚ OpenAI  â”‚ â”‚Anthropicâ”‚ â”‚ Chroma  â”‚ â”‚ Google  â”‚           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    å…­å¤§æ ¸å¿ƒç»„ä»¶ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    1. Models (æ¨¡å‹)     - LLM å’Œ Chat æ¨¡å‹çš„ç»Ÿä¸€å°è£…
    2. Prompts (æç¤ºè¯)  - æç¤ºè¯æ¨¡æ¿ç®¡ç†
    3. Chains (é“¾)       - ç»„ä»¶çš„é“¾å¼è°ƒç”¨
    4. Memory (è®°å¿†)     - å¯¹è¯å†å²å’ŒçŠ¶æ€ç®¡ç†
    5. Indexes (ç´¢å¼•)    - æ–‡æ¡£åŠ è½½ã€åˆ†å‰²ã€å‘é‡å­˜å‚¨
    6. Agents (ä»£ç†)     - è‡ªä¸»å†³ç­–å’Œå·¥å…·è°ƒç”¨
    """
    print(architecture_text)


# ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®‰è£…ä¸é…ç½® ====================


def setup_demo():
    """å®‰è£…ä¸é…ç½®æ¼”ç¤º"""
    print("\n" + "=" * 60)
    print("ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®‰è£…ä¸é…ç½®")
    print("=" * 60)

    setup_text = """
    å®‰è£…å‘½ä»¤ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    # åŸºç¡€å®‰è£…
    pip install langchain langchain-openai
    
    # å®Œæ•´å®‰è£…ï¼ˆåŒ…å«å¸¸ç”¨ä¾èµ–ï¼‰
    pip install langchain langchain-openai langchain-community
    
    # å‘é‡æ•°æ®åº“æ”¯æŒ
    pip install chromadb faiss-cpu
    
    ç¯å¢ƒé…ç½®ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    æ–¹å¼ä¸€ï¼šä½¿ç”¨ .env æ–‡ä»¶
    ```
    OPENAI_API_KEY=sk-your-key-here
    ```
    
    æ–¹å¼äºŒï¼šä»£ç ä¸­è®¾ç½®
    ```python
    import os
    os.environ["OPENAI_API_KEY"] = "sk-your-key-here"
    ```
    """
    print(setup_text)

    # æ£€æŸ¥å½“å‰ç¯å¢ƒé…ç½®
    print("\nğŸ“Œ å½“å‰ç¯å¢ƒæ£€æŸ¥ï¼š")
    print("-" * 40)

    api_key = os.getenv("OPENAI_API_KEY")
    if api_key:
        print(f"âœ… OPENAI_API_KEY å·²é…ç½®: {api_key[:8]}...{api_key[-4:]}")
    else:
        print("âŒ OPENAI_API_KEY æœªé…ç½®")
        return

    # æµ‹è¯• LangChain å¯¼å…¥
    try:
        import langchain

        print(f"âœ… langchain ç‰ˆæœ¬: {langchain.__version__}")
    except ImportError:
        print("âŒ langchain æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install langchain")
        return

    try:
        from langchain_openai import ChatOpenAI

        print("âœ… langchain-openai å·²å®‰è£…")
    except ImportError:
        print("âŒ langchain-openai æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install langchain-openai")
        return

    print("\nâœ… ç¯å¢ƒé…ç½®å®Œæˆï¼Œå¯ä»¥å¼€å§‹å­¦ä¹ ï¼")


# ==================== ç¬¬å››éƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ª LangChain åº”ç”¨ ====================


def first_langchain_app():
    """ç¬¬ä¸€ä¸ª LangChain åº”ç”¨"""
    print("\n" + "=" * 60)
    print("ç¬¬å››éƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ª LangChain åº”ç”¨")
    print("=" * 60)

    print("\nğŸ“Œ ç¤ºä¾‹ 1ï¼šä½¿ç”¨ ChatOpenAI")
    print("-" * 40)

    try:
        from langchain_openai import ChatOpenAI
        from langchain_core.messages import HumanMessage, SystemMessage

        # åˆ›å»ºæ¨¡å‹å®ä¾‹
        llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)

        # æ–¹å¼ä¸€ï¼šç®€å•è°ƒç”¨
        print("\næ–¹å¼ä¸€ï¼šç›´æ¥è°ƒç”¨ invoke()")
        response = llm.invoke("ç”¨ä¸€å¥è¯è§£é‡Šä»€ä¹ˆæ˜¯ LangChain")
        print(f"å›å¤: {response.content}")

        # æ–¹å¼äºŒï¼šä½¿ç”¨æ¶ˆæ¯åˆ—è¡¨
        print("\næ–¹å¼äºŒï¼šä½¿ç”¨æ¶ˆæ¯åˆ—è¡¨")
        messages = [
            SystemMessage(content="ä½ æ˜¯ä¸€ä¸ª Python ä¸“å®¶ï¼Œå›ç­”ç®€æ´æ˜äº†"),
            HumanMessage(content="LangChain çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ"),
        ]
        response = llm.invoke(messages)
        print(f"å›å¤: {response.content}")

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        return

    print("\nğŸ“Œ ç¤ºä¾‹ 2ï¼šä½¿ç”¨ LCEL æ„å»ºç®€å•é“¾")
    print("-" * 40)

    try:
        from langchain_core.prompts import ChatPromptTemplate
        from langchain_core.output_parsers import StrOutputParser

        # åˆ›å»ºæç¤ºè¯æ¨¡æ¿
        prompt = ChatPromptTemplate.from_template(
            "è¯·ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šè¿™ä¸ªæŠ€æœ¯æ¦‚å¿µï¼š{concept}"
        )

        # ä½¿ç”¨ LCEL æ„å»ºé“¾ï¼šprompt -> llm -> parser
        chain = prompt | llm | StrOutputParser()

        # è°ƒç”¨é“¾
        result = chain.invoke({"concept": "å‘é‡æ•°æ®åº“"})
        print(f"è§£é‡Šç»“æœ:\n{result}")

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        return

    print("\nğŸ“Œ ç¤ºä¾‹ 3ï¼šæµå¼è¾“å‡º")
    print("-" * 40)

    try:
        print("æµå¼å›å¤: ", end="")
        for chunk in chain.stream({"concept": "RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ)"}):
            print(chunk, end="", flush=True)
        print()  # æ¢è¡Œ

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")


# ==================== ç¬¬äº”éƒ¨åˆ†ï¼šLCEL åˆæ¢ ====================


def lcel_intro():
    """LCEL è¡¨è¾¾å¼è¯­è¨€åˆæ¢"""
    print("\n" + "=" * 60)
    print("ç¬¬äº”éƒ¨åˆ†ï¼šLCEL è¡¨è¾¾å¼è¯­è¨€åˆæ¢")
    print("=" * 60)

    lcel_text = """
    ä»€ä¹ˆæ˜¯ LCELï¼Ÿ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    LCEL (LangChain Expression Language) æ˜¯ LangChain çš„æ ¸å¿ƒç¼–ç¨‹èŒƒå¼ï¼Œ
    ä½¿ç”¨ç®¡é“ç¬¦ | å°†ç»„ä»¶ä¸²è”èµ·æ¥ï¼Œæ„å»ºå¤æ‚çš„å¤„ç†é“¾ã€‚
    
    åŸºæœ¬è¯­æ³•ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    chain = component1 | component2 | component3
    
    å…¸å‹é“¾ç»“æ„ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Prompt  â”‚ â”€â–¶ â”‚   LLM    â”‚ â”€â–¶ â”‚  Parser  â”‚ â”€â–¶ â”‚  Output  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    ä»£ç è¡¨ç¤ºï¼šchain = prompt | llm | parser
    
    LCEL çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    1. ç»Ÿä¸€æ¥å£ï¼šæ‰€æœ‰ç»„ä»¶éƒ½æ”¯æŒ invoke, stream, batch æ–¹æ³•
    2. æµå¼æ”¯æŒï¼šå¼€ç®±å³ç”¨çš„æµå¼è¾“å‡º
    3. å¼‚æ­¥æ”¯æŒï¼šæ”¯æŒ async/await
    4. å¹¶è¡Œæ‰§è¡Œï¼šä½¿ç”¨ RunnableParallel å¹¶è¡Œå¤„ç†
    5. å›é€€æœºåˆ¶ï¼šä½¿ç”¨ with_fallbacks å¤„ç†é”™è¯¯
    """
    print(lcel_text)

    # å®é™…æ¼”ç¤º
    print("\nğŸ“Œ LCEL æ ¸å¿ƒæ–¹æ³•æ¼”ç¤ºï¼š")
    print("-" * 40)

    try:
        from langchain_openai import ChatOpenAI
        from langchain_core.prompts import ChatPromptTemplate
        from langchain_core.output_parsers import StrOutputParser

        llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)
        prompt = ChatPromptTemplate.from_template("ç”¨ä¸€å¥è¯æè¿°{topic}çš„ç‰¹ç‚¹")
        chain = prompt | llm | StrOutputParser()

        # 1. invoke - åŒæ­¥è°ƒç”¨
        print("\n1. invoke() - åŒæ­¥è°ƒç”¨:")
        result = chain.invoke({"topic": "Python"})
        print(f"   ç»“æœ: {result}")

        # 2. batch - æ‰¹é‡è°ƒç”¨
        print("\n2. batch() - æ‰¹é‡è°ƒç”¨:")
        topics = [{"topic": "Java"}, {"topic": "Rust"}, {"topic": "Go"}]
        results = chain.batch(topics)
        for topic, result in zip(topics, results):
            print(f"   {topic['topic']}: {result}")

        # 3. stream - æµå¼è°ƒç”¨
        print("\n3. stream() - æµå¼è°ƒç”¨:")
        print("   ç»“æœ: ", end="")
        for chunk in chain.stream({"topic": "JavaScript"}):
            print(chunk, end="", flush=True)
        print()

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")


# ==================== ç¬¬å…­éƒ¨åˆ†ï¼šç»ƒä¹ ä¸æ€è€ƒ ====================


def exercises():
    """ç»ƒä¹ é¢˜"""
    print("\n" + "=" * 60)
    print("ç»ƒä¹ ä¸æ€è€ƒ")
    print("=" * 60)

    exercises_text = """
    ç»ƒä¹  1ï¼šç¯å¢ƒéªŒè¯
        æ£€æŸ¥ä½ çš„ç¯å¢ƒæ˜¯å¦æ­£ç¡®é…ç½®äº† LangChainï¼Œå¹¶æ‰“å°å‡ºç‰ˆæœ¬å·ã€‚
        
        æç¤ºï¼šä½¿ç”¨ langchain.__version__
        
        å‚è€ƒç­”æ¡ˆï¼š
        ```python
        import langchain
        print(f"LangChain ç‰ˆæœ¬: {langchain.__version__}")
        ```

    ç»ƒä¹  2ï¼šæ„å»ºç®€å•é“¾
        ä½¿ç”¨ LCEL æ„å»ºä¸€ä¸ªç¿»è¯‘é“¾ï¼Œå°†ä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡ã€‚
        
        æç¤ºï¼šä½¿ç”¨ ChatPromptTemplate å’Œ StrOutputParser
        
        å‚è€ƒç­”æ¡ˆï¼š
        ```python
        from langchain_openai import ChatOpenAI
        from langchain_core.prompts import ChatPromptTemplate
        from langchain_core.output_parsers import StrOutputParser

        llm = ChatOpenAI()
        prompt = ChatPromptTemplate.from_template(
            "è¯·å°†ä»¥ä¸‹ä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡ï¼š{text}"
        )
        chain = prompt | llm | StrOutputParser()
        result = chain.invoke({"text": "ä»Šå¤©å¤©æ°”çœŸå¥½"})
        print(result)
        ```

    ç»ƒä¹  3ï¼šæ‰¹é‡å¤„ç†
        ä½¿ç”¨ batch() æ–¹æ³•åŒæ—¶ç¿»è¯‘å¤šæ®µæ–‡æœ¬ã€‚
        
        å‚è€ƒç­”æ¡ˆï¼š
        ```python
        texts = [
            {"text": "ä½ å¥½"},
            {"text": "è°¢è°¢"},
            {"text": "å†è§"}
        ]
        results = chain.batch(texts)
        for text, result in zip(texts, results):
            print(f"{text['text']} -> {result}")
        ```

    æ€è€ƒé¢˜ï¼š
        1. LangChain ç›¸æ¯”ç›´æ¥è°ƒç”¨ OpenAI API æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ
        2. LCEL çš„ç®¡é“ç¬¦è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ
        3. ä»€ä¹ˆåœºæ™¯é€‚åˆä½¿ç”¨æµå¼è¾“å‡ºï¼Ÿ
    """
    print(exercises_text)


# ==================== ä¸»å‡½æ•° ====================


def main():
    """ä¸»å‡½æ•° - æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰éƒ¨åˆ†"""
    print("ğŸš€ LangChain æ¡†æ¶æ¦‚è¿°")
    print("=" * 60)
    print("âš ï¸ æ³¨æ„ï¼šæœ¬è¯¾ç¨‹å°†è°ƒç”¨ OpenAI APIï¼Œä¼šäº§ç”Ÿå°‘é‡è´¹ç”¨")
    print("é¢„ä¼°æ¶ˆè€—ï¼šçº¦ 1000-2000 tokens")
    print("=" * 60)

    # æ£€æŸ¥ç¯å¢ƒ
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        print("âŒ é”™è¯¯ï¼šæœªè®¾ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡")
        print("è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®æˆ–è¿è¡Œï¼š")
        print('export OPENAI_API_KEY="your-key-here"')
        return

    try:
        introduction()
        core_architecture()
        setup_demo()
        first_langchain_app()
        lcel_intro()
        exercises()
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback

        traceback.print_exc()
        return

    print("\n" + "=" * 60)
    print("âœ… è¯¾ç¨‹å®Œæˆï¼")
    print("ä¸‹ä¸€æ­¥ï¼š02-llm-models.pyï¼ˆLLM æ¨¡å‹å°è£…ï¼‰")
    print("=" * 60)


if __name__ == "__main__":
    main()
